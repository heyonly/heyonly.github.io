---
layout: post
title: iOS 安全攻防之敏感数据保护
categories: blog
description: iOS 安全攻防
keywords: iOS 安全攻防,敏感数据
---
在我们的印象中，iOS 似乎很安全，今年肆虐的wannacry 病毒貌似没有报告说iOS 系统中招的。尽管如此，也不可大意。顺便提醒一下，没有特别需求，最好不要越狱。




我们知道，文件系统就像一本很大的书，当一个文件被删除时，许多人认为页面被一个共享文件删除，就像51区的分类文档一样。事实上，当一个文件被删除时，就像有人那红笔给那个文件打了一个红X，文件内容并没有被真正删除，如果想恢复这个文件，只需要将那把红X 删除就可以了。当然，你知我知，大家知，当然苹果也知。所以在iOS4以后，苹果采用了一种特殊的处理方式，那就是对本地文件系统加密。这样，即使有人恢复了删除的文件，没有密钥，也无法读取内容，这样就打打的增强了数据的安全性。


在iOS4 以后，Apple采用文件系统加密的方式增强数据的安全性。每一个文件都用一个唯一的key 来进行加密，而每一个文件都有一个属性叫cprotect，这个key 存储在cprotect文件属性。事实上，这个用于解密文件系统的key 的值又是用另一个DKey 采用AES 加密的，存储在一个NSND 区域，当一个文件被删除时，这个cprotect 这个属性就设置为discarded。这个删除的文件没有了cprotect 这个属性，这个文件也就无法解密，即使恢复了也毫无意义。



当然，这只是增加破解的难度。熟悉Linux 的人都知道，Linux中有一个日志系统（Windows我就不知道了），这个日志系统记录着系统中所发生的一切，网络传输，文件更改，任务调度等等。当然iOS也有一个日至系统 HFS（Hierarchical File System,分层文件系统）。这个日志系统记录着iOS中所发生的一切。刚刚说了，iOS中所有文件都是加密的，这个日志系统记录的日志文件也是加密的,给这个日至系统加密的秘钥叫EMF key。但是有一个地方没有加密，那就是NAND 分区，这个地方存储着密钥，这个日志系统的密钥就存在这个地方，只需要用户口令就可以解密的（可以对这个用户口令采取暴力破解）。从NAND分区中获取日志系统的EMF key，从而就可以知道系统中所发生的一切，当然也就破解了整个文件系统。



以上只是从理论上知道了如何破解文件系统。事实上，这只是一个道高一尺，魔高一丈的游戏。作为一个开发人员，我们要做是如何保护好我们的敏感数据。不管怎么样，也得增加破解者的难度吧。




很多金融APP 在输入密码的时候都是采用自己的键盘，而不是使用系统的键盘。因为系统键盘，都有键盘缓存。而键盘缓存就存在/private/var/mobile/Library/Keyboard/dynamic-text.dat 文件中，导出该缓存文件，查看内容，你会发现，一切输入都是明文存储的。因为系统不会把所有的用户输入记录都当做密码等敏感信息来处理。既然缓存在文件中，当然是把文件删除，然后让其无法再HFS 日志系统无法找到。最好的就是讲这个文件overwrite。








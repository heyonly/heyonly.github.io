一、背景  
 &#160;&#160;由于此次一个项目，我们打包后，总是有崩溃，经过分析，是由于用户名密码没有取到，导致用户名密码为空，而APP 的开发者又没有对用户密码判空，最终导致崩溃。经过进一步分析，用户名密码是存储在keychain 中，经过我们重签名后，从keychain 中取不出数据。    

    

二、问题   
 1) keychain 是什么  
 2）keychain 如何存取数据     
 3）为什么会取不出数据      
 4）要如何修改，才能让APP 正常取出数据     
 
 1、keychain 是什么   
 iOS APP的Keychain数据是存储在应用沙箱外面的，各APP的keychain数据内容为逻辑隔离，由系统进程securityd实施访问控制。为了在多个APP间能够共享Keychain信息，Apple引入了Keychain访问组概念：拥有相同Keychain访问组标识符的应用，可以共享Keychain数据。
 
 2、如何存取数据   
   
 ```
- (BOOL)addItemWithService:(NSString *)service account:(NSString *)account password:(NSString *)password {

   	NSMutableDictionary *queryDict = [NSMutableDictionary dictionary];
  	queryDict[(__bridge id)kSecAttrAccessGroup] = @"com.uusafe.keychainDemo";
    
    [queryDict setObject:service forKey:(__bridge id)kSecAttrService];
    [queryDict setObject:account forKey:(__bridge id)kSecAttrAccount];
    [queryDict setObject:(__bridge id)kSecClassGenericPassword forKey:(__bridge id)kSecClass];
    
    OSStatus status = -1;
    
    CFTypeRef result = NULL;
    
    status = SecItemCopyMatching((__bridge CFDictionaryRef)queryDict, &result);
    
    if (status == errSecItemNotFound) {
        NSData *passwordData = [password dataUsingEncoding:NSUTF8StringEncoding];
        [queryDict setObject:passwordData forKey:(__bridge id)kSecValueData];
        
        status = SecItemAdd((__bridge CFDictionaryRef)queryDict, NULL);
        NSLog(@"插入成功%d",status);
    }else if(status == errSecSuccess) {
        NSData *passwordData = [password dataUsingEncoding:NSUTF8StringEncoding];
        
        NSMutableDictionary *dict = [[NSMutableDictionary alloc] initWithDictionary:queryDict];
        
        [dict setObject:passwordData forKey:(__bridge id)kSecValueData];
        
        status = SecItemUpdate((__bridge CFDictionaryRef)queryDict, (__bridge CFDictionaryRef)dict);
    }
    return (status == errSecSuccess);
}
 ```
 
 
 > 注意，这里有个kSecAttrAccessGroup 后面用的到。        
 
 我们一个一个来解释这些key。这里有一个图，来自网上：     
 
 ![](/images/blog/keychain/1448203-99aefc4b87db83ae.jpeg)     
 
 * kSecClassInternetPassword     
 	属于该类别的条目往往用来存储上网登录密码，远程服务器密码等
 * kSecClassGenericPassword    
 	存储一些通用的密码，比如数据库密码，***连接的密码等等
 * kSecClassCertificate
 * kSecClassKey
 * kSecClassIdentity    
 	这三类条目往往用于建立基于证书，秘钥和公钥系统的安全连接。    
 * kSecReturnData   
 	返回条目所存储的数据，返回值类型是CFDataRef
 
 设置所属类别    
 
```
[queryDict setObject:(__bridge id)kSecClassGenericPassword forKey:(__bridge id)kSecClass]
```   
 
 设置所属服务    
   
```
[queryDict setObject:service forKey:(__bridge id)kSecAttrService];
```  
 
 设置用户名和密码    
 
```
[queryDict setObject:account forKey:(__bridge id)kSecAttrAccount];    
```   
 
```
[queryDict setObject:passwordData forKey:(__bridge id)kSecValueData];     
```   
 >注意：kSecAttrService 和 kSecAttrAccount 不可以都重复，共同组成主键     
 
 
 返回条目数量，是所有还是只查询一个    
 
```
[queryDict setObject:(__bridge id)kSecMatchLimit forKey:(__bridge id)kSecMatchLimitAll];

```   


另外，我们知道，keychain中的数据是可以迁移到其他设备的。这就涉及到iOS 的数据保护机制：存储在Keychain中的数据被另一层与用户密码(passcode)相关联的加密机制保护着。数据保护加密密钥（保护类密钥-protection class keys）是由一个设备硬件密钥和一个由用户密码衍生的密钥共同产生的。可以通过向Keychain接口的SecItemAdd或SecItemUpdate方法的kSecAttrAccessible属性提供一个可访问常量来启用Keychain的数据保护。该可访问常量值决定一个Keychain条目在何时可被应用访问，同时也决定某个Keychain条目是否允许移动到另一台设备上。
以下是keychain 条目的数据可访问常量列表：   
   
* kSecAttrAccessibleWhenUnlocked    
  Keychain条目只能在设备被解锁后被访问，此时用于解密Keychain条目的数据保护类密钥只在设备被解锁后才会被加载到内存中，并且当设备锁定后，加密密钥将在10s钟内自动清除。    
* kSecAttrAccessibleAfterFirstUnlock   
Keychain条目可以在设备第一次解锁到重启过程中被访问，此时用于解密Keychain条目的数据保护类密钥只有在用户重启并解锁设备后才会被加载到内存中，并且该密钥将一直保留在内存中，直到下一次设备重启。
* kSecAttrAccessibleAlways  
  Keychain条目即使在设备锁定时也可被访问，此时用于解密Keychain条目的数据保护类密钥一直被加载在内存中。
* kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly
  keychian 条目在设置了密码的情况下，并且设备解锁了，应用在前台才能访问，并且无法迁移到其他设备，也无法被分到新设备，这个属性在没有密码的设备上不生效
* kSecAttrAccessibleWhenUnlockedThisDeviceOnly
  Keychain条目只能在设备被解锁后被访问，并且无法在设备间移动。 
* kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly
  Keychain条目可在设备第一次解锁后访问，但无法在设备间移动
* kSecAttrAccessibleAlwaysThisDeviceOnly  
  Keychain条目即使在设备锁定时也可被访问，但无法在设备间移动
  
Keychain条目的数据保护可访问常量被映射到各Keychain表(genp、inet..)中的pdmn列(protection domain)。下表显示了keychain数据保护可访问常量和pdmn值之间的映射关系。

![](/images/blog/keychain/keychain-pdmn-values.jpg)    


当然keychain也不是绝对安全的。在越狱机器上可以使用Keychain_dumper 将所有keychain 条目导出。     
我们可以用  Keychain_dumper 导出来看看    

![](/images/blog/keychain/41FFB5CA-BB93-40D6-9B71-7659C22F3234.png)    

keychain 是一个用有限访问权限的sqlite 数据库，（据说是aes256 加密，但是可以直接导出来看到是明文的），在iPhone 上，Keychain存放在“/private/var/Keychains/keychain-2.db” SQLite数据库。可以将sqlite 数据库导出来打开看看   
![](/images/blog/keychain/class-keychain.png)   


   
![](/images/blog/keychain/75CD657A-8CB4-400F-BB13-48C9C815CD98.png)   













  
 
 
 
 


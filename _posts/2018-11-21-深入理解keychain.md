**ä¸€ã€èƒŒæ™¯**  
 &#160;&#160;ç”±äºæ­¤æ¬¡ä¸€ä¸ªé¡¹ç›®ï¼Œæˆ‘ä»¬æ‰“åŒ…åï¼Œæ€»æ˜¯æœ‰å´©æºƒï¼Œç»è¿‡åˆ†æï¼Œæ˜¯ç”±äºç”¨æˆ·åå¯†ç æ²¡æœ‰å–åˆ°ï¼Œå¯¼è‡´ç”¨æˆ·åå¯†ç ä¸ºç©ºï¼Œè€ŒAPP çš„å¼€å‘è€…åˆæ²¡æœ‰å¯¹ç”¨æˆ·å¯†ç åˆ¤ç©ºï¼Œæœ€ç»ˆå¯¼è‡´å´©æºƒã€‚ç»è¿‡è¿›ä¸€æ­¥åˆ†æï¼Œç”¨æˆ·åå¯†ç æ˜¯å­˜å‚¨åœ¨keychain ä¸­ï¼Œç»è¿‡æˆ‘ä»¬é‡ç­¾ååï¼Œä»keychain ä¸­å–ä¸å‡ºæ•°æ®ã€‚    

    

**äºŒã€é—®é¢˜**   
 1) keychain æ˜¯ä»€ä¹ˆ  
 2ï¼‰keychain å¦‚ä½•å­˜å–æ•°æ®     
 3ï¼‰ä¸ºä»€ä¹ˆä¼šå–ä¸å‡ºæ•°æ®      
 4ï¼‰è¦å¦‚ä½•ä¿®æ”¹ï¼Œæ‰èƒ½è®©APP æ­£å¸¸å–å‡ºæ•°æ®     
 
**1ã€keychain æ˜¯ä»€ä¹ˆ**   
 &#160;&#160;iOS APPçš„Keychainæ•°æ®æ˜¯å­˜å‚¨åœ¨åº”ç”¨æ²™ç®±å¤–é¢çš„ï¼Œå„APPçš„keychainæ•°æ®å†…å®¹ä¸ºé€»è¾‘éš”ç¦»ï¼Œç”±ç³»ç»Ÿè¿›ç¨‹securitydå®æ–½è®¿é—®æ§åˆ¶ã€‚ä¸ºäº†åœ¨å¤šä¸ªAPPé—´èƒ½å¤Ÿå…±äº«Keychainä¿¡æ¯ï¼ŒAppleå¼•å…¥äº†Keychainè®¿é—®ç»„æ¦‚å¿µï¼šæ‹¥æœ‰ç›¸åŒKeychainè®¿é—®ç»„æ ‡è¯†ç¬¦çš„åº”ç”¨ï¼Œå¯ä»¥å…±äº«Keychainæ•°æ®ã€‚
 
 **2ã€å¦‚ä½•å­˜å–æ•°æ®**   
   
 ```
- (BOOL)addItemWithService:(NSString *)service account:(NSString *)account password:(NSString *)password {

   	NSMutableDictionary *queryDict = [NSMutableDictionary dictionary];
  	queryDict[(__bridge id)kSecAttrAccessGroup] = @"com.uusafe.keychainDemo";
    
    [queryDict setObject:service forKey:(__bridge id)kSecAttrService];
    [queryDict setObject:account forKey:(__bridge id)kSecAttrAccount];
    [queryDict setObject:(__bridge id)kSecClassGenericPassword forKey:(__bridge id)kSecClass];
    
    OSStatus status = -1;
    
    CFTypeRef result = NULL;
    
    status = SecItemCopyMatching((__bridge CFDictionaryRef)queryDict, &result);
    
    if (status == errSecItemNotFound) {
        NSData *passwordData = [password dataUsingEncoding:NSUTF8StringEncoding];
        [queryDict setObject:passwordData forKey:(__bridge id)kSecValueData];
        
        status = SecItemAdd((__bridge CFDictionaryRef)queryDict, NULL);
        NSLog(@"æ’å…¥æˆåŠŸ%d",status);
    }else if(status == errSecSuccess) {
        NSData *passwordData = [password dataUsingEncoding:NSUTF8StringEncoding];
        
        NSMutableDictionary *dict = [[NSMutableDictionary alloc] initWithDictionary:queryDict];
        
        [dict setObject:passwordData forKey:(__bridge id)kSecValueData];
        
        status = SecItemUpdate((__bridge CFDictionaryRef)queryDict, (__bridge CFDictionaryRef)dict);
    }
    return (status == errSecSuccess);
}
 ```
 
 
 > æ³¨æ„ï¼Œè¿™é‡Œæœ‰ä¸ªkSecAttrAccessGroup åé¢ç”¨çš„åˆ°ã€‚        
 
 æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥è§£é‡Šè¿™äº›keyã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå›¾ï¼Œæ¥è‡ªç½‘ä¸Šï¼š     
 
 ![](/images/blog/keychain/1448203-99aefc4b87db83ae.jpeg)     
 
 * kSecClassInternetPassword     
 	å±äºè¯¥ç±»åˆ«çš„æ¡ç›®å¾€å¾€ç”¨æ¥å­˜å‚¨ä¸Šç½‘ç™»å½•å¯†ç ï¼Œè¿œç¨‹æœåŠ¡å™¨å¯†ç ç­‰
 * kSecClassGenericPassword    
 	å­˜å‚¨ä¸€äº›é€šç”¨çš„å¯†ç ï¼Œæ¯”å¦‚æ•°æ®åº“å¯†ç ï¼Œ***è¿æ¥çš„å¯†ç ç­‰ç­‰
 * kSecClassCertificate
 * kSecClassKey
 * kSecClassIdentity    
 	è¿™ä¸‰ç±»æ¡ç›®å¾€å¾€ç”¨äºå»ºç«‹åŸºäºè¯ä¹¦ï¼Œç§˜é’¥å’Œå…¬é’¥ç³»ç»Ÿçš„å®‰å…¨è¿æ¥ã€‚    
 * kSecReturnData   
 	è¿”å›æ¡ç›®æ‰€å­˜å‚¨çš„æ•°æ®ï¼Œè¿”å›å€¼ç±»å‹æ˜¯CFDataRef
 
 è®¾ç½®æ‰€å±ç±»åˆ«    
 
```
[queryDict setObject:(__bridge id)kSecClassGenericPassword forKey:(__bridge id)kSecClass]
```   
 
 è®¾ç½®æ‰€å±æœåŠ¡    
   
```
[queryDict setObject:service forKey:(__bridge id)kSecAttrService];
```  
 
 è®¾ç½®ç”¨æˆ·åå’Œå¯†ç     
 
```
[queryDict setObject:account forKey:(__bridge id)kSecAttrAccount];    
```   
 
```
[queryDict setObject:passwordData forKey:(__bridge id)kSecValueData];     
```   
 >æ³¨æ„ï¼škSecAttrService å’Œ kSecAttrAccount ä¸å¯ä»¥éƒ½é‡å¤ï¼Œå…±åŒç»„æˆä¸»é”®     
 
 
 è¿”å›æ¡ç›®æ•°é‡ï¼Œæ˜¯æ‰€æœ‰è¿˜æ˜¯åªæŸ¥è¯¢ä¸€ä¸ª    
 
```
[queryDict setObject:(__bridge id)kSecMatchLimit forKey:(__bridge id)kSecMatchLimitAll];

```   


å¦å¤–ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œkeychainä¸­çš„æ•°æ®æ˜¯å¯ä»¥è¿ç§»åˆ°å…¶ä»–è®¾å¤‡çš„ã€‚è¿™å°±æ¶‰åŠåˆ°iOS çš„æ•°æ®ä¿æŠ¤æœºåˆ¶ï¼šå­˜å‚¨åœ¨Keychainä¸­çš„æ•°æ®è¢«å¦ä¸€å±‚ä¸ç”¨æˆ·å¯†ç (passcode)ç›¸å…³è”çš„åŠ å¯†æœºåˆ¶ä¿æŠ¤ç€ã€‚æ•°æ®ä¿æŠ¤åŠ å¯†å¯†é’¥ï¼ˆä¿æŠ¤ç±»å¯†é’¥-protection class keysï¼‰æ˜¯ç”±ä¸€ä¸ªè®¾å¤‡ç¡¬ä»¶å¯†é’¥å’Œä¸€ä¸ªç”±ç”¨æˆ·å¯†ç è¡ç”Ÿçš„å¯†é’¥å…±åŒäº§ç”Ÿçš„ã€‚å¯ä»¥é€šè¿‡å‘Keychainæ¥å£çš„SecItemAddæˆ–SecItemUpdateæ–¹æ³•çš„kSecAttrAccessibleå±æ€§æä¾›ä¸€ä¸ªå¯è®¿é—®å¸¸é‡æ¥å¯ç”¨Keychainçš„æ•°æ®ä¿æŠ¤ã€‚è¯¥å¯è®¿é—®å¸¸é‡å€¼å†³å®šä¸€ä¸ªKeychainæ¡ç›®åœ¨ä½•æ—¶å¯è¢«åº”ç”¨è®¿é—®ï¼ŒåŒæ—¶ä¹Ÿå†³å®šæŸä¸ªKeychainæ¡ç›®æ˜¯å¦å…è®¸ç§»åŠ¨åˆ°å¦ä¸€å°è®¾å¤‡ä¸Šã€‚
ä»¥ä¸‹æ˜¯keychain æ¡ç›®çš„æ•°æ®å¯è®¿é—®å¸¸é‡åˆ—è¡¨ï¼š   
   
* kSecAttrAccessibleWhenUnlocked    
  Keychainæ¡ç›®åªèƒ½åœ¨è®¾å¤‡è¢«è§£é”åè¢«è®¿é—®ï¼Œæ­¤æ—¶ç”¨äºè§£å¯†Keychainæ¡ç›®çš„æ•°æ®ä¿æŠ¤ç±»å¯†é’¥åªåœ¨è®¾å¤‡è¢«è§£é”åæ‰ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”å½“è®¾å¤‡é”å®šåï¼ŒåŠ å¯†å¯†é’¥å°†åœ¨10sé’Ÿå†…è‡ªåŠ¨æ¸…é™¤ã€‚    
* kSecAttrAccessibleAfterFirstUnlock   
Keychainæ¡ç›®å¯ä»¥åœ¨è®¾å¤‡ç¬¬ä¸€æ¬¡è§£é”åˆ°é‡å¯è¿‡ç¨‹ä¸­è¢«è®¿é—®ï¼Œæ­¤æ—¶ç”¨äºè§£å¯†Keychainæ¡ç›®çš„æ•°æ®ä¿æŠ¤ç±»å¯†é’¥åªæœ‰åœ¨ç”¨æˆ·é‡å¯å¹¶è§£é”è®¾å¤‡åæ‰ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”è¯¥å¯†é’¥å°†ä¸€ç›´ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡è®¾å¤‡é‡å¯ã€‚
* kSecAttrAccessibleAlways  
  Keychainæ¡ç›®å³ä½¿åœ¨è®¾å¤‡é”å®šæ—¶ä¹Ÿå¯è¢«è®¿é—®ï¼Œæ­¤æ—¶ç”¨äºè§£å¯†Keychainæ¡ç›®çš„æ•°æ®ä¿æŠ¤ç±»å¯†é’¥ä¸€ç›´è¢«åŠ è½½åœ¨å†…å­˜ä¸­ã€‚
* kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly
  keychian æ¡ç›®åœ¨è®¾ç½®äº†å¯†ç çš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸”è®¾å¤‡è§£é”äº†ï¼Œåº”ç”¨åœ¨å‰å°æ‰èƒ½è®¿é—®ï¼Œå¹¶ä¸”æ— æ³•è¿ç§»åˆ°å…¶ä»–è®¾å¤‡ï¼Œä¹Ÿæ— æ³•è¢«åˆ†åˆ°æ–°è®¾å¤‡ï¼Œè¿™ä¸ªå±æ€§åœ¨æ²¡æœ‰å¯†ç çš„è®¾å¤‡ä¸Šä¸ç”Ÿæ•ˆ
* kSecAttrAccessibleWhenUnlockedThisDeviceOnly
  Keychainæ¡ç›®åªèƒ½åœ¨è®¾å¤‡è¢«è§£é”åè¢«è®¿é—®ï¼Œå¹¶ä¸”æ— æ³•åœ¨è®¾å¤‡é—´ç§»åŠ¨ã€‚ 
* kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly
  Keychainæ¡ç›®å¯åœ¨è®¾å¤‡ç¬¬ä¸€æ¬¡è§£é”åè®¿é—®ï¼Œä½†æ— æ³•åœ¨è®¾å¤‡é—´ç§»åŠ¨
* kSecAttrAccessibleAlwaysThisDeviceOnly  
  Keychainæ¡ç›®å³ä½¿åœ¨è®¾å¤‡é”å®šæ—¶ä¹Ÿå¯è¢«è®¿é—®ï¼Œä½†æ— æ³•åœ¨è®¾å¤‡é—´ç§»åŠ¨
  
Keychainæ¡ç›®çš„æ•°æ®ä¿æŠ¤å¯è®¿é—®å¸¸é‡è¢«æ˜ å°„åˆ°å„Keychainè¡¨(genpã€inet..)ä¸­çš„pdmnåˆ—(protection domain)ã€‚ä¸‹è¡¨æ˜¾ç¤ºäº†keychainæ•°æ®ä¿æŠ¤å¯è®¿é—®å¸¸é‡å’Œpdmnå€¼ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚

![](/images/blog/keychain/keychain-pdmn-values.jpg)    


å½“ç„¶keychainä¹Ÿä¸æ˜¯ç»å¯¹å®‰å…¨çš„ã€‚åœ¨è¶Šç‹±æœºå™¨ä¸Šå¯ä»¥ä½¿ç”¨Keychain_dumper å°†æ‰€æœ‰keychain æ¡ç›®å¯¼å‡ºã€‚     
æˆ‘ä»¬å¯ä»¥ç”¨  Keychain_dumper å¯¼å‡ºæ¥çœ‹çœ‹    

![](/images/blog/keychain/415179C2-56DE-442E-BFDB-72F40CFBBDB1.png)    

keychain æ˜¯ä¸€ä¸ªç”¨æœ‰é™è®¿é—®æƒé™çš„sqlite æ•°æ®åº“ï¼Œï¼ˆæ®è¯´æ˜¯aes256 åŠ å¯†ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥å¯¼å‡ºæ¥çœ‹åˆ°æ˜¯æ˜æ–‡çš„ï¼‰ï¼Œåœ¨iPhone ä¸Šï¼ŒKeychainå­˜æ”¾åœ¨â€œ/private/var/Keychains/keychain-2.dbâ€ SQLiteæ•°æ®åº“ã€‚å¯ä»¥å°†sqlite æ•°æ®åº“å¯¼å‡ºæ¥æ‰“å¼€çœ‹çœ‹   
![](/images/blog/keychain/class-keychain.png)   


   
![](/images/blog/keychain/1813DA7C-D869-4472-86B0-FCAE3CCEB207.png)   


ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªç±»åˆ«å°±æœ‰ä¸€å¼ è¡¨ï¼Œè¿™é‡Œå°±æœ‰æˆ‘ä»¬åˆšåˆšçœ‹åˆ°çš„ä¸€åˆ‡ä¿¡æ¯ã€‚å¯ä»¥çœ‹åˆ°æ¯ä¸ªå­—æ®µä¿¡æ¯ã€‚




ä»¥ä¸Šå°±æ˜¯è‹¹æœæš´éœ²ç»™æˆ‘ä»¬çš„ã€‚




æ¥ä¸‹æ¥ï¼Œè¦çœŸæ­£äº†è§£å¦‚ä½•æ’å…¥keychain ä¿¡æ¯çš„ï¼Œé‚£ä¹ˆç¨å¾®äº†è§£ä¸€ç‚¹iOS IPC é€šä¿¡ã€‚


**<h6>XPC é€šä¿¡</h6>**

æˆ‘ä»¬çŸ¥é“IPCé€šä¿¡çš„åŸºæœ¬æ–¹å¼æœ‰APP groupï¼Œå‰ªåˆ‡æ¿ï¼Œkeychainï¼Œè¿™äº›éƒ½æ˜¯æˆ‘ä»¬å¹³æ—¶å¼€å‘ç”¨åˆ°çš„ã€‚ä½†æ˜¯æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€å¤æ‚çš„é€šä¿¡æ–¹å¼XPC é€šä¿¡ã€‚é€šè¿‡xpcï¼ŒAPP å¯ä»¥ä¸ä¸€äº›ç³»ç»ŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚




åœ¨iOS ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªAPP éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œå½“APP è¦ä¸å…¶ä»–è¿›ç¨‹é€šä¿¡æ—¶ï¼Œéƒ½ä¼šå»ºç«‹ä¸€ä¸ªxpc è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥éƒ½æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œæ„å‘³ç€æœåŠ¡åœ¨ä¸åŒçš„è¿æ¥è¿›è¡Œæ“ä½œæ—¶ï¼Œéƒ½ä¼šè°ƒç”¨xpc_connection_createå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é“¾æ¥

```
xpc_connection_t c = xpc_connection_create("com.example.service", NULL);
xpc_connection_set_event_handler(c, ^(xpc_object_t event) {
    // ...
});
xpc_connection_resume(c);
```
å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªè¿æ¥éƒ½ä¼šæœ‰ä¸€ä¸ªhandlerï¼Œå¯ä»¥ç†è§£ä¸ºå›è°ƒ

å½“ä¸€ä¸ªæ¶ˆæ¯å‘é€åˆ°xpcè¿æ¥ï¼Œå°†è‡ªåŠ¨å°†æ¶ˆæ¯æ´¾å‘åˆ°ä¸€ä¸ªç”±runtime ç®¡ç†çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚å½“è¿æ¥çš„è¿œç«¯ä¸€å•å¼€å¯çš„æ—¶å€™ï¼Œæ¶ˆæ¯è®²å‡ºå¯¹å¹¶è¢«å‘é€ã€‚    
æ¯ä¸ªæ¶ˆæ¯å°±æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå­—ç¬¦çªœkey å’Œå¼ºç±»å‹å€¼ï¼š   

```
xpc_dictionary_t message = xpc_dictionary_create(NULL, NULL, 0);
xpc_dictionary_set_uint64(message, "foo", 1);
xpc_connection_send_message(c, message);
xpc_release(message)

```

å…³äºxpc é€šä¿¡çš„èµ„æ–™å¤ªå°‘ï¼Œç½‘ä¸Šæœ‰äººç§°ä¸ºå¤©ä½¿ä¸æ¶é­”ğŸ˜ˆ




**3ã€ä¸ºä»€ä¹ˆä¼šå–ä¸å‡ºæ•°æ®**    
&#160;&#160;è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œå¿…é¡»å¾—å¯¹keychainçš„å¢åˆ æ”¹æŸ¥çš„åŸç†å¼„æ¸…æ¥šã€‚   
&#160;&#160;åœ¨keychainä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨`SecItemAdd` æ—¶ï¼ŒAPPä¼šä¸ç³»ç»ŸæœåŠ¡securityd å»ºç«‹ä¸€ä¸ªxpc è¿æ¥ï¼Œåœ¨securityd ä¸­ï¼Œå½“æœ‰æ¶ˆæ¯å‘é€è¿‡æ¥æ˜¯ï¼Œå°±ä¼šè°ƒç”¨ï¼š

```
void __fastcall securityd_xpc_dictionary_handler(__int64 a1, __int64 a2)
``` 


åœ¨è¿™ä¸ªå‡½æ•°ä¸­ä¼šæœ‰ä¸€ç³»åˆ—æ“ä½œï¼ŒåŒ…æ‹¬è·å–åŠå†³å®š`keychain-access-group`ã€å¢åˆ æ”¹æŸ¥ç­‰ã€‚    

1ã€å…ˆæ¥çœ‹çœ‹å¦‚ä½•è·å–åŠå†³å®š`keychain-access-group`   
 
```
v9 = CFDataCreate(v12, &v248, 32LL);
  pthread_setspecific(taskThreadKey, v10);
  v8 = SecTaskCopyAccessGroups((__int64)v10);
  v7 = 0LL;
  if ( (v11 & 0xFFFFFFFFFFFFFFFELL) == 26 )
    v7 = SecTaskCopyArrayOfStringsForEntitlement(v10, CFSTR(â€œcom.apple.developer.associated-domains"));
```


é‡ç‚¹å…³æ³¨`SecTaskCopyAccessGroups` æˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹ï¼š    

```
__int64 __fastcall SecTaskCopyAccessGroups(__int64 a1)
{
  __int64 v1; // x21
  __int64 v2; // x19
  __int64 v3; // x20
  __int64 v4; // x21
  __int64 v5; // x24
  __int64 v6; // x23
  signed __int64 v7; // x8
  __int64 v8; // x0
  __int64 v9; // x22

  v1 = a1;
  v2 = SecTaskCopyArrayOfStringsForEntitlement(a1, CFSTR("keychain-access-groups"));
  v3 = SecTaskCopyArrayOfStringsForEntitlement(v1, CFSTR("com.apple.security.application-groups"));
  v4 = SecTaskCopyApplicationIdentifier(v1);
  if ( v2 )
    v5 = CFArrayGetCount(v2);
  else
    v5 = 0LL;
  if ( v3 )
    v6 = CFArrayGetCount(v3);
  else
    v6 = 0LL;
  if ( v4 )
    v7 = v5 + 1;
  else
    v7 = v5;
  if ( v7 + v6 )
  {
    v8 = CFArrayCreateMutable(kCFAllocatorDefault);
    v9 = v8;
    if ( v5 )
      CFArrayAppendArray(v8, v2, 0LL, v5);
    if ( v4 )
      CFArrayAppendValue(v9, v4);
    if ( v6 )
      CFArrayAppendArray(v9, v3, 0LL, v6);
  }
  else
  {
    v9 = 0LL;
  }
  if ( v4 )
    CFRelease(v4);
  if ( v2 )
    CFRelease(v2);
  if ( v3 )
    CFRelease(v3);
  return v9;
}

```


å¯ä»¥çœ‹åˆ°é¦–å…ˆè·å– `SecTaskCopyArrayOfStringsForEntitlement(a1, CFSTR("keychain-access-groups"));`

ç„¶åè·å– `SecTaskCopyArrayOfStringsForEntitlement(v1, CFSTR("com.apple.security.application-groups"));`

æœ€å`SecTaskCopyApplicationIdentifier(v1);`   

ä½†æ˜¯è¯·æ³¨æ„ï¼ŒåŠ å…¥æ•°ç»„ä¸­çš„é¡ºåºï¼š   
é¦–å…ˆæ˜¯keychain-access-groupï¼Œç„¶åbundleIDï¼Œæœ€åæ˜¯app-group   
è¿™ä¸ªé¡ºåºå¾ˆé‡è¦ï¼Œå³æœ€åæ•°ç»„ä¸­çš„ä¿¡æ¯åº”è¯¥æ˜¯ï¼š   
1ã€keychain-access-group       
2ã€bundleID    
3ã€app-group   


æ¥ä¸‹æ¥å°±æ˜¯switch è¯­å¥ï¼Œåˆ†åˆ«æ˜¯å¢åˆ æ”¹æŸ¥    

```
switch ( v11 )
  {
    case 0uLL:
      v14 = SecXPCDictionaryCopyDictionary(v2, kSecXPCKeyQuery[0], v253 + 3);
      v15 = v14;
      if ( v14 )
      {
        v244 = 0LL;
        if ( (unsigned int)_SecItemAdd(v14, v8, (__int64)&v244, (__int64)(v253 + 3)) )
          v16 = v244 == 0;
        else
          v16 = 1;
        if ( !v16 )
        {
          SecXPCDictionarySetPList(v6, kSecXPCKeyResult[0], v244, v253 + 3);
          v17 = v244;
          goto LABEL_129;
        }
        goto LABEL_231;
      }
      goto def_100002C00;
    case 1uLL:
      v18 = SecXPCDictionaryCopyDictionary(v2, kSecXPCKeyQuery[0], v253 + 3);
      v15 = v18;
      if ( v18 )
      {
        v243 = 0LL;
        if ( (unsigned int)_SecItemCopyMatching(v18, v8, &v243) )
          v19 = v243 == 0;
        else
          v19 = 1;
        if ( !v19 )
        {
          SecXPCDictionarySetPList(v6, kSecXPCKeyResult[0], v243, v253 + 3);
          v17 = v243;
          goto LABEL_129;
        }
        goto LABEL_231;
      }
      goto def_100002C00;
    case 2uLL:
      v20 = SecXPCDictionaryCopyDictionary(v2, kSecXPCKeyQuery[0], v253 + 3);
      if ( v20 )
      {
        v21 = SecXPCDictionaryCopyDictionary(v2, kSecXPCKeyAttributesToUpdate[0], v253 + 3);
        if ( !v21 )
          goto LABEL_226;
        v22 = _SecItemUpdate(v20, v21, v8, v253 + 3);
        xpc_dictionary_set_bool(v6, kSecXPCKeyResult[0], v22);
        v23 = v21;
        goto LABEL_77;
      }
      goto def_100002C00;
    case 3uLL:
      v24 = SecXPCDictionaryCopyDictionary(v2, kSecXPCKeyQuery[0], v253 + 3);
      v15 = v24;
      if ( v24 )
      {
        v25 = _SecItemDelete(v24, v8, v253 + 3);
        goto LABEL_43;
      }

```

æˆ‘ä»¬åªæ¥çœ‹çœ‹SecItemAdd   

```
v14 = SecXPCDictionaryCopyDictionary(v2, (__int64)kSecXPCKeyQuery[0], (__int64)(v252 + 3));
```

åœ¨è¿™ä¸ªå‡½æ•°ä¸­ç‚¹è¿›å»ï¼Œå¯ä»¥çœ‹åˆ°ï¼š

```
__int64 __fastcall SecXPCDictionaryCopyPList(__int64 a1, __int64 a2, __int64 a3)
{
  __int64 v3; // x19
  __int64 v4; // x0
  __int64 v5; // x0
  __int64 result; // x0
  __int64 v7; // [xsp+18h] [xbp-28h]

  v3 = a3;
  v7 = 0LL;
  v4 = xpc_dictionary_get_data();
  if ( v4 )
  {
    if ( der_decode_plist(kCFAllocatorDefault, 0LL, &v7, v3, v4, v4) != v4 )
    {
      SecError(4294967246LL, v3, CFSTR("trailing garbage after der decoded object for key %s"));
      v5 = v7;
      if ( v7 )
      {
        v7 = 0LL;
        CFRelease(v5);
      }
    }
    result = v7;
  }
  else
  {
    SecError(4294967246LL, v3, CFSTR("no object for key %s"));
    result = 0LL;
  }
  return result;
}
```
  
å¯ä»¥çœ‹åˆ°v8 æ˜¯æ•°ç»„ï¼Œæˆ‘ä»¬é€šè¿‡`SecXPCDictionaryCopyDictionary ` çŒœæµ‹ï¼Œv14 å°±æ˜¯æ¶ˆæ¯ä½“ï¼Œæ¶ˆæ¯ä½“é‡åŒ…å«`keychain-access-group` æ­¤æ—¶ï¼Œ`SecItemAdd` çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸­åŒ…å«`keychain-access-group`ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸ª`SecTaskCopyAccessGroups `è¿”å›çš„æ•°ç»„ï¼Œæ¥ç€æˆ‘ä»¬é‡ç‚¹åˆ†æ`SecItemAdd ` çš„å®ç°:

```
__int64 __fastcall _SecItemAdd(__int64 a1, __int64 a2, __int64 a3, __int64 a4)
{
  __int64 v4; // x19
  __int64 v5; // x21
  __int64 v6; // x22
  __int64 v7; // x23
  __int64 v8; // x24
  _QWORD *v9; // x20
  __int64 v10; // x25
  __int64 v11; // x23
  int v12; // w0
  __int64 v13; // x0
  __int64 v14; // x2
  signed __int64 v15; // x1
  __int64 v17; // x0
  void **v18; // [xsp+8h] [xbp-78h]
  int v19; // [xsp+10h] [xbp-70h]
  int v20; // [xsp+14h] [xbp-6Ch]
  __int64 (__fastcall *v21)(); // [xsp+18h] [xbp-68h]
  void *v22; // [xsp+20h] [xbp-60h]
  __int64 v23; // [xsp+28h] [xbp-58h]
  _QWORD *v24; // [xsp+30h] [xbp-50h]
  __int64 v25; // [xsp+38h] [xbp-48h]

  v4 = a4;
  v5 = a3;
  v6 = a2;
  v7 = a1;
  if ( a2 )
  {
    v8 = CFArrayGetCount(a2);
    if ( v8 )
    {
      v9 = query_create_with_limit(v7, 0LL, v4);
      if ( !v9 )
        return 0LL;
      v10 = kSecAttrAccessGroup;
      v11 = CFDictionaryGetValue(v7, kSecAttrAccessGroup);
      v12 = CFArrayContainsValue(v6, 0LL, v8, CFSTR("*"));
      if ( v11 )
      {
        if ( v12 )
          v13 = 0LL;
        else
          v13 = v6;
        if ( !accessGroupsAllows(v13, v11) && !(unsigned int)SecError(4294942053LL, v4, CFSTR("NoAccessForItem")) )
        {
          v15 = 0LL;
          return query_notify_and_destroy(v9, v15, v4);
        }
      }
      else
      {
        v11 = CFArrayGetValueAtIndex(v6, 0LL);
        query_add_attribute(v10, v11, v9);
      }
      query_ensure_access_control((__int64)v9, v11, v14);
      if ( v9[9] )
      {
        v17 = SecError(4294967246LL, v4, CFSTR("q_row_id"));
      }
      else
      {
        if ( v9[5] )
        {
          v15 = 1LL;
          return query_notify_and_destroy(v9, v15, v4);
        }
        v18 = _NSConcreteStackBlock;
        v19 = 0x40000000;
        v20 = 0;
        v21 = ___SecItemAdd_block_invoke;
        v22 = &__block_descriptor_tmp30;
        v23 = v4;
        v24 = v9;
        v25 = v5;
        v17 = kc_with_dbt(1LL, v4, &v18);
      }
      v15 = v17;
      return query_notify_and_destroy(v9, v15, v4);
    }
  }
  if ( SecTaskDiagnoseEntitlements )
    SecTaskDiagnoseEntitlements(v6);
  return SecError(
           4294933278LL,
           v4,
           CFSTR("client has neither application-identifier nor keychain-access-groups entitlements"));
}

```   


æˆ‘ä»¬æ¥ç®€å•åˆ†æä¸€ä¸‹ä¸Šé¢çš„ä»£ç     
é¦–å…ˆåˆ¤æ–­a2 æ˜¯å¦ä¸ºç©ºï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼Œa2 ä¸ä¼šä¸ºç©ºï¼Œå› ä¸ºAPP æ€»ä¼šæœ‰bundleIDï¼‰ï¼Œå¦‚æœä¸ºç©ºï¼Œç›´æ¥è¿”å›-34018 é”™è¯¯ã€‚     
å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ä»v7 ä¸­å–å‡º`kSecAttrAccessGroup` v11ã€‚ è¿™ä¸ªv11 å³æ˜¯æˆ‘ä»¬æœ€å¼€å§‹å¤„

```
queryDict[(__bridge id)kSecAttrAccessGroup] = @"com.uusafe.keychainDemo";
```
çš„`kSecAttrAccessGroup `

* å¦‚æœv11 ä¸ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­v8 æ•°ç»„ä¸­æ˜¯å¦åŒ…å«`*` è‹¥æœæœ‰å…ƒç´ æ˜¯`*`åˆ™v13 = 0ï¼Œå¦åˆ™v13 = v6ï¼Œè¿™ä¸ªv6 å³æ˜¯æ•°ç»„ã€‚æ¥ç€é€šè¿‡`accessGroupsAllows ` åˆ¤æ–­`keychain-access-group `æ˜¯å¦å¯ä»¥è®¿é—®ã€‚

```
bool __fastcall accessGroupsAllows(__int64 a1, __int64 a2)
{
  __int64 v2; // x20
  __int64 v3; // x19
  __int64 v4; // x21
  __int64 v5; // x21
  _BOOL8 result; // x0

  v2 = a2;
  v3 = a1;
  result = 1;
  if ( a1 )
  {
    if ( !a2
      || (v4 = CFGetTypeID(a2), v4 != CFStringGetTypeID())
      || (v5 = CFArrayGetCount(v3)) == 0
      || !(unsigned int)CFArrayContainsValue(v3, 0LL, v5, v2)
      && !(unsigned int)CFArrayContainsValue(v3, 0LL, v5, CFSTR("*")) )
    {
      result = 0;
    }
  }
  return result;
}
```

å¯ä»¥çœ‹åˆ°v13 = 0 æ—¶ï¼Œæ°¸è¿œè¿”å›çš„æ˜¯ 1.å³å¦‚æœæ˜¯`*` è¡¨ç¤ºæ‰€æœ‰çš„éƒ½æœ‰è®¿é—®æƒé™ã€‚    

* å¦‚æœv11 ä¸ºç©ºï¼Œå³æˆ‘ä»¬å†å­˜å‚¨çš„æ—¶å€™ä¸ä¼ å…¥`keychain-access-group` ,é‚£ä¹ˆå°±ä¼šå»æ•°ç»„çš„ç¬¬ä¸€ä¸ªã€‚ 
  
```
v11 = CFArrayGetValueAtIndex(v6, 0LL);
query_add_attribute(v10, v11, v9);
```
å¹¶ä¸”å°†å–åˆ°çš„ é»˜è®¤`keychain` æ·»åŠ åˆ°`keychain` çš„å±æ€§ä¸­ã€‚ 

æ¥ç€ä¾¿æ˜¯é€šè¿‡`query_ensure_access_control` æ¥å†³å®šè®¿é—®æƒé™åˆ—è¡¨ï¼Œå³åœ¨æ–‡ç« å¼€å¤´å‡ºæåˆ°çš„`pdmn` å­—æ®µ


```
__int64 __fastcall query_ensure_access_control(__int64 result, __int64 a2, __int64 a3)
{
  __int64 v3; // x20
  __CFString ***v4; // x19
  __int64 v5; // x2
  __int64 *v6; // x8

  v3 = a2;
  v4 = (__CFString ***)result;
  if ( !*(_QWORD *)(result + 112) )
  {
    if ( (unsigned int)CFEqual(a2, CFSTR("com.apple.apsd"), a3)
      || (unsigned int)CFEqual(v3, CFSTR("lockdown-identities"), v5) )
    {
      v6 = (__int64 *)&kSecAttrAccessibleAlwaysThisDeviceOnly;
    }
    else if ( *v4 == &cert_class )
    {
      v6 = (__int64 *)&kSecAttrAccessibleAlways;
    }
    else
    {
      v6 = (__int64 *)&kSecAttrAccessibleWhenUnlocked;
    }
    result = query_add_attribute(kSecAttrAccessible, *v6, v4);
  }
  return result;
}
```


è¿™äº›ä¸Šé¢æœ‰è¿‡è§£é‡Šï¼Œè¿™é‡Œå°±ä¸è¯´äº†ã€‚ä¹Ÿå¯ä»¥ä¸ä¸Šé¢æåˆ°çš„ä¸€ä¸€å¯¹åº”ä¸Šã€‚    

å½“è¿™äº›å…¨éƒ½é€šè¿‡åï¼Œä¾¿é€šè¿‡`kc_with_dbt` è¿›è¡Œæ•°æ®åº“æ“ä½œã€‚

```
__int64 __fastcall kc_with_dbt(int a1, __int64 *a2, __int64 a3, __int64 a4, __int64 a5, __int64 a6, __int64 a7, __int64 a8)
{
  __int64 v8; // x19
  __int64 *v9; // x20
  int v10; // w21
  __int64 v11; // x20
  __int64 v12; // x19
  __int64 v14; // [xsp+0h] [xbp-20h]

  v8 = a3;
  v9 = a2;
  v10 = a1;
  if ( a1 )
    SecItemDataSourceFactoryGetDefault();
  if ( _kc_dbhandle_once != -1 )
    dispatch_once(&_kc_dbhandle_once, &__block_literal_global223);
  if ( !_kc_dbhandle )
  {
    SecError(-25316, v9, (__int64)CFSTR("failed to get a db handle"), a4, a5, a6, a7, a8, v14);
    return 0LL;
  }
  v11 = SecDbConnectionAquire(_kc_dbhandle, v10 ^ 1u, (__int64)v9);
  if ( !v11 )
    return 0LL;
  v12 = (*(__int64 (__fastcall **)(__int64, __int64))(v8 + 16))(v8, v11);
  SecDbConnectionRelease(v11);
  return v12;
}
```


å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡ŒåŸºæœ¬ä¸Šå°±æ˜¯æ•°æ®åº“æ“ä½œäº†ï¼Œè‡³æ­¤ï¼Œ`keychain` çš„add æ“ä½œæƒé™é‰´å®šé˜¶æ®µå®Œæˆã€‚    
ä»è¿™é‡Œå¯ä»¥è§£é‡Šæˆ‘ä»¬é‡æ–°ç­¾ååä»`keychain`ä¸­ä¸ºä»€ä¹ˆå–ä¸å‡ºæ•°æ®äº†ã€‚

**4ã€å¦‚ä½•ä¿®æ”¹**   
åœ¨è¿™é‡Œç‰µæ¶‰åˆ°æˆ‘ä»¬ä¸šåŠ¡æ“ä½œï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚



**ä¸‰ã€æ€»ç»“**     
&#160;&#160;ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š      
1ã€å¦‚æœ`keychain-access-group` æœ‰`*` ,è¡¨ç¤ºåŒ¹é…æ‰€æœ‰ï¼Œå³ä¸å­˜åœ¨`no-access-item ` çš„æƒ…å†µ     

2ã€åœ¨ä¹¦å†™ä»£ç æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ä¸æŒ‡å®š`access-group` åˆ™é»˜è®¤æŠŠæ•°ç»„ä¸­ç¬¬ä¸€ä¸ªä½œä¸ºé»˜è®¤å€¼ã€‚





